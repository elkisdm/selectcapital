window.onTurnstileSuccess=function(e){const t=document.getElementById("ts-token"),o=document.getElementById("form-submit-btn");t&&(t.value=e),o&&(o.disabled=!1)},document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".footer-logo-light"),t=document.querySelector(".footer-logo-dark"),o=()=>{const o=document.documentElement.getAttribute("data-theme");e&&t&&("dark"===o?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none"))};o();new MutationObserver(()=>{o()}).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]});const n=document.querySelector('[data-action="scroll-form"]'),r=document.getElementById("btn-ver-proceso"),a=e=>{e&&e.preventDefault();const t=document.getElementById("contacto");t&&t.scrollIntoView({behavior:"smooth",block:"start"})};function s(e){if(!e)return"";let t=e.replace(/\D/g,"");return t.startsWith("56")&&(t=t.slice(2)),t.startsWith("0")&&(t=t.slice(1)),t.length>0&&t.length<9&&(t.startsWith("9")||(t="9"+t)),t=t.slice(-9),9===t.length&&t.startsWith("9")?`+56 ${t.slice(0,1)} ${t.slice(1,5)} ${t.slice(5,9)}`:e}function c(e){if(!e)return"";const t=["de","del","la","las","los","el","y","e"];return e.trim().split(/\s+/).map((e,o)=>o>0&&t.includes(e.toLowerCase())?e.toLowerCase():e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}n&&n.addEventListener("click",a),r&&r.addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("proceso");t&&t.scrollIntoView({behavior:"smooth",block:"start"})});const i=document.querySelector(".form");if(i){const e=i.querySelector("#telefono");e&&(e.addEventListener("input",t=>{const o=t.target.value;let n=o.replace(/\D/g,"");if(n.startsWith("56")&&(n=n.slice(2)),n.startsWith("0")&&(n=n.slice(1)),n=n.slice(0,9),n.length>0){!n.startsWith("9")&&n.length<=8&&(n="9"+n.slice(0,8));let t="+56 "+n.slice(0,1);n.length>1&&(t+=" "+n.slice(1,5)),n.length>5&&(t+=" "+n.slice(5,9));const r=e.selectionStart;if(t!==o){e.value=t;const n=Math.min(r+(t.length-o.length),t.length);e.setSelectionRange(n,n)}}}),e.addEventListener("blur",e=>{e.target.value=s(e.target.value)}),e.setAttribute("inputmode","numeric"),e.setAttribute("pattern","[0-9]*"));const t=i.querySelector("#correo");t&&t.addEventListener("blur",e=>{e.target.value=e.target.value.trim().toLowerCase()});const o=i.querySelector("#nombre");o&&o.addEventListener("blur",e=>{e.target.value=c(e.target.value)})}const l=document.getElementById("form-submit-btn");function d(e,t){u();const o=document.createElement("div");o.className=`form-message ${t}`,o.innerHTML=`\n      <strong>${"success"===t?"✓":"⚠"}</strong>\n      <span>${e}</span>\n    `,o.style.cssText=`\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 14px 18px;\n      border-radius: 12px;\n      margin: 16px 0;\n      font-size: 14px;\n      line-height: 1.5;\n      ${"success"===t?"background: rgba(34, 197, 94, 0.1); border: 1.5px solid rgba(34, 197, 94, 0.3); color: #16a34a;":"background: rgba(248, 113, 113, 0.1); border: 1.5px solid rgba(248, 113, 113, 0.3); color: #dc2626;"}\n    `;const n=document.querySelector(".form-footer");n&&n.insertBefore(o,n.firstChild)}function u(){document.querySelectorAll(".form-message").forEach(e=>e.remove())}i&&l&&i.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("ts-token");if(!t||!t.value)return d("Por favor, completa la verificación de seguridad antes de enviar.","error"),!1;const o=i.querySelector("#telefono"),n=i.querySelector("#correo"),r=i.querySelector("#nombre");if(o){const e=o.value,t=s(e);o.value=t;if(!(function(e){if(!e)return!1;const t=e.replace(/\D/g,"");return 9===t.length&&t.startsWith("9")||11===t.length&&t.startsWith("569")}(e)||/^\+56\s9\s\d{4}\s\d{4}$/.test(t)))return d("Por favor, ingresa un número de WhatsApp válido chileno (9 dígitos, ej: 912345678).","error"),o.focus(),!1}n&&(n.value=n.value.trim().toLowerCase()),r&&(r.value=c(r.value)),l.disabled=!0;const a=l.innerHTML;l.innerHTML='<span class="btn-primary-icon">⏳</span><span>Enviando...</span>',l.style.opacity="0.7",l.style.cursor="not-allowed",u();const m=(()=>{const e=[Date.now(),i.querySelector("#correo")?.value||"",i.querySelector("#telefono")?.value||"",i.querySelector("#nombre")?.value||"",Math.random().toString(36)].join("|");let t=0;for(let o=0;o<e.length;o++){t=(t<<5)-t+e.charCodeAt(o),t&=t}return Math.abs(t).toString(36)+Date.now().toString(36)})();try{const e=new FormData;e.append("meta_event_id",m),e.append("nombre",i.querySelector("#nombre")?.value||""),e.append("email",i.querySelector("#correo")?.value||""),e.append("whatsapp",i.querySelector("#telefono")?.value||""),e.append("renta_rango",i.querySelector("#renta")?.value||""),e.append("complemento_renta",i.querySelector("#complemento")?.value||""),e.append("situacion_financiera",i.querySelector("#situacion")?.value||""),e.append("capacidad_ahorro",i.querySelector("#ahorro")?.value||""),e.append("canal_preferido",i.querySelector("#contacto")?.value||"whatsapp"),e.append("proyecto","Asesoría Integral"),e.append("objetivo","asesoria");const o=i.querySelector("#terminos")?.checked;e.append("consentimiento_privacidad",o?"si":"no"),e.append("consentimiento_contacto",o?"si":"no"),e.append("cf-turnstile-response",t.value),e.append("honey","");const n=new URLSearchParams(window.location.search);e.append("utm_source",n.get("utm_source")||""),e.append("utm_medium",n.get("utm_medium")||""),e.append("utm_campaign",n.get("utm_campaign")||""),e.append("gclid",n.get("gclid")||""),e.append("fbclid",n.get("fbclid")||""),e.append("ttclid",n.get("ttclid")||"");const r=await fetch("/submit.php",{method:"POST",body:e}),a=await r.json();if(!a.ok)throw new Error(a.message||"Error al enviar el formulario");{window.fbq&&fbq("track","Lead",{content_name:"Asesoría Integral",content_category:"Formulario Contacto",eventID:m}),window.SelectTracking&&window.SelectTracking.trackEvent("form_submit_success",{source:"home"});const e=i.querySelector("#nombre"),t=e?e.value.split(" ")[0]:"",o=t?`/gracias.html?nombre=${encodeURIComponent(t)}`:"/gracias.html";window.location.href=o}}catch(e){("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("dev."))&&console.error("Form submission error:",e),d(e.message||"Hubo un problema al enviar tu solicitud. Por favor intenta nuevamente.","error")}finally{l.disabled=!1,l.innerHTML=a,l.style.opacity="1",l.style.cursor="pointer"}})});const setThemeFromSystem=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";document.documentElement.setAttribute("data-theme",e)};setThemeFromSystem(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",setThemeFromSystem),document.querySelectorAll(".sticky-nav-links a").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.getAttribute("href"),n=document.querySelector(o);if(n){const e=n.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:e,behavior:"smooth"})}})});const throttle=(e,t)=>{let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}},updateActiveNavLink=()=>{const e=document.querySelectorAll("section[id]"),t=document.querySelectorAll(".sticky-nav-links a"),o=window.pageYOffset+150;e.forEach(e=>{const n=e.offsetTop,r=e.offsetHeight,a=e.getAttribute("id");o>=n&&o<n+r&&t.forEach(e=>{e.classList.remove("active"),e.getAttribute("href")===`#${a}`&&e.classList.add("active")})}),window.pageYOffset<100&&t.forEach(e=>e.classList.remove("active"))};window.addEventListener("scroll",throttle(updateActiveNavLink,100)),updateActiveNavLink();const scrollProgress=document.getElementById("scroll-progress");if(scrollProgress){const e=()=>{const e=window.innerHeight,t=document.documentElement.scrollHeight,o=(window.pageYOffset||document.documentElement.scrollTop)/(t-e)*100;scrollProgress.style.width=`${Math.min(o,100)}%`};window.addEventListener("scroll",throttle(e,16)),e()}const initFloatingCTA=()=>{const e=document.getElementById("floating-cta");if(!e)return;const t=document.getElementById("contacto"),o=()=>{if(window.innerWidth>640)return void e.classList.add("hidden");const o=window.pageYOffset||document.documentElement.scrollTop,n=window.innerHeight;if(o<300)e.classList.add("hidden");else if(t){const o=t.getBoundingClientRect();o.top<n&&o.bottom>0?e.classList.add("hidden"):e.classList.remove("hidden")}else e.classList.remove("hidden")};e.querySelector("a")?.addEventListener("click",e=>{if(e.preventDefault(),t){const e=t.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:e,behavior:"smooth"})}}),window.addEventListener("scroll",throttle(o,100)),window.addEventListener("resize",throttle(o,200)),o()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(initFloatingCTA,500)}):setTimeout(initFloatingCTA,500);